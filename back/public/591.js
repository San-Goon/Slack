"use strict";(self.webpackChunkfront=self.webpackChunkfront||[]).push([[591],{8591:function(e,t,n){n.r(t),n.d(t,{default:function(){return w}});var a=n(2309),l=n(2545),o=n(8678),r=n(3564),s=n(7294),c=n(5977),i=n(2503),u=n(9732),m=n(958),d=n(2951),h=n(9669),p=n.n(h),f=n(8667),g=n(5692),v=n(3046),b=n(9249),k=({show:e,onCloseModal:t,setShowInviteChannelModal:n})=>{const{workspace:a,channel:l}=(0,c.UO)(),[u,m,d]=(0,o.Z)(""),{data:h}=(0,i.ZP)("/api/users",r.Z),{mutate:f}=(0,i.ZP)(h?`/api/workspaces/${a}/channels/${l}/members`:null,r.Z),k=(0,s.useCallback)((e=>{e.preventDefault(),u&&u.trim()&&p().post(`/api/workspaces/${a}/channels/${l}/members`,{email:u}).then((()=>{f(),n(!1),d("")})).catch((e=>{var t;console.dir(e),b.Am.error(null===(t=e.response)||void 0===t?void 0:t.data,{position:"bottom-center"})}))}),[u,a,l]);return s.createElement(g.Z,{show:e,onCloseModal:t},s.createElement("form",{onSubmit:k},s.createElement(v.__,{id:"member-label"},s.createElement("span",null,"채널 멤버 초대"),s.createElement(v.II,{id:"member",value:u,onChange:m})),s.createElement(v.zx,{type:"submit"},"초대하기")))},w=()=>{var e,t;const{workspace:n,channel:h}=(0,c.UO)(),{data:g}=(0,i.ZP)("/api/users",r.Z),[v,b,w]=(0,o.Z)(""),{data:C,mutate:E,setSize:Z}=(0,m.ZP)((e=>`/api/workspaces/${n}/channels/${h}/chats?perPage=20&page=${e+1}`),r.Z),{data:$}=(0,i.ZP)(`/api/workspaces/${n}/channels/${h}`,r.Z),{data:S}=(0,i.ZP)(g?`/api/workspaces/${n}/channels/${h}/members`:null,r.Z),[T]=(0,d.Z)(n),_=0===(null==C||null===(e=C[0])||void 0===e?void 0:e.length)||C&&(null===(t=C[C.length-1])||void 0===t?void 0:t.length)<20||!1,D=(0,s.useRef)(null),[I,P]=(0,s.useState)(!1),[M,U]=(0,s.useState)(!1),A=(0,s.useCallback)((e=>{if(e.preventDefault(),console.log(v),null!=v&&v.trim()&&C&&$){const e=v;E((t=>{var n;return null==t||t[0].unshift({id:((null===(n=C[0][0])||void 0===n?void 0:n.id)||0)+1,content:e,UserId:g.id,User:g,ChannelId:$.id,Channel:$,createdAt:new Date}),t}),!1).then((()=>{var e;localStorage.setItem(`${n}-${h}`,(new Date).getTime().toString()),w(""),null===(e=D.current)||void 0===e||e.scrollToBottom()})),p().post(`/api/workspaces/${n}/channels/${h}/chats`,{content:v}).then((()=>{E()})).catch(console.error)}}),[v,C,g,$,n,h]),B=(0,s.useCallback)((e=>{e.Channel.name!==h||!e.content.startsWith("uploads\\")&&e.UserId===(null==g?void 0:g.id)||E((t=>(null==t||t[0].unshift(e),t)),!1).then((()=>{var e;D.current&&D.current.getScrollHeight()<D.current.getClientHeight()+D.current.getScrollTop()+150&&(console.log("scrollToBottom!",null===(e=D.current)||void 0===e?void 0:e.getValues()),setTimeout((()=>{var e;null===(e=D.current)||void 0===e||e.scrollToBottom()}),50))}))}),[h,g]);(0,s.useEffect)((()=>{localStorage.setItem(`${n}-${h}`,(new Date).getTime().toString())}),[n,h]),(0,s.useEffect)((()=>(null==T||T.on("message",B),()=>{null==T||T.off("message",B)})),[T,B]),(0,s.useEffect)((()=>{var e;1===(null==C?void 0:C.length)&&(null===(e=D.current)||void 0===e||e.scrollToBottom())}),[C]);const y=(0,s.useCallback)((()=>{P(!0)}),[]),z=(0,s.useCallback)((()=>{P(!1)}),[]),F=(0,s.useCallback)((e=>{console.log(e);const t=new FormData;if(e.dataTransfer.items){for(let n=0;n<e.dataTransfer.items.length;n++)if("file"===e.dataTransfer.items[n].kind){const a=e.dataTransfer.items[n].getAsFile();console.log("... file["+n+"].name ="+a.name),t.append("image",a)}}else for(let n=0;n<e.dataTransfer.files.length;n++)console.log("...file["+n+"].name="+e.dataTransfer.files[n].name),t.append("image",e.dataTransfer.files[n]);p().post(`/api/workspaces/${n}/channels/${h}/images`,t).then((()=>{U(!1)}))}),[n,h]),N=(0,s.useCallback)((e=>{e.preventDefault(),console.log(e),U(!0)}),[]);if(!g)return null;const O=(0,f.Z)(C?C.flat().reverse():[]);return s.createElement(u.W2,{onDrop:F,onDragOver:N},s.createElement(u.h4,null,s.createElement("span",null,"#",h),s.createElement("div",{className:"header-right"},s.createElement("span",null,null==S?void 0:S.length),s.createElement("button",{onClick:y,className:"c-button-unstyled p-ia__view_header__button","aria-label":"Add people to #react-native","data-sk":"tooltip-parent",type:"button"},s.createElement("i",{className:"c-icon p-ia__view_header__button_icon c-icon--add-user","aria-hidden":"true"})))),s.createElement(l.Z,{chatSections:O,ref:D,setSize:Z,isReachingEnd:_}),s.createElement(a.Z,{chat:v,onChangeChat:b,onSubmitForm:A}),s.createElement(k,{show:I,onCloseModal:z,setShowInviteChannelModal:P}),M&&s.createElement(u.KW,null,"업로드!"))}}}]);